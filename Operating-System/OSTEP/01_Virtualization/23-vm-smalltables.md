# 📏 페이징: 더 작은 테이블 (OSTEP Chapter 23)

이 장에서는 가상 메모리의 핵심 기법인 **페이징(Paging)** 에서 발생하는 **페이지 테이블의 크기 문제**를 해결하기 위한 여러 가지 방법을 살펴본다.  
선형 페이지 테이블(linear page table)은 단순하지만 공간 낭비가 크고, 이를 보완하기 위해 **페이지 크기 조정, 세그멘테이션 결합, 멀티 레벨 테이블, 역 페이지 테이블** 등 다양한 최적화가 사용된다.

---

## ❓ 핵심 질문

> 페이징 기반 주소 변환 시스템에서 **페이지 테이블이 지나치게 커지는 문제를 어떻게 줄일 수 있을까?**

---

## 🔍 상세 개념 정리

### 23.1 간단한 방법: 페이지 크기 늘리기

#### ✅ 효과
- 페이지 크기를 키우면 필요한 페이지 수가 줄어듦 → 페이지 테이블 크기 감소
- 예: 4KB → 16KB로 변경 시, 페이지 수가 1/4로 감소

#### ⚠️ 단점
- 페이지 내부에 사용하지 않는 공간이 생김 → **내부 단편화(Internal Fragmentation)** 증가
- 작은 데이터만 필요한 경우에도 큰 페이지 전체가 할당됨

#### 💡 적용 사례
- 데이터베이스나 대형 캐시 같은 경우에 **큰 페이지(Superpage)** 사용
- 대부분의 경우 일반 프로그램은 작은 페이지(4KB, 8KB)를 유지

---

### 23.2 하이브리드 방법: 세그멘테이션 + 페이징

#### 🔧 구조
- 전체 주소 공간을 **세그먼트 단위**로 구분 (코드, 힙, 스택 등)
- 각 세그먼트마다 **별도의 페이지 테이블** 관리

#### 🧠 동작 방식
1. 가상 주소 상위 비트로 세그먼트 결정
2. 해당 세그먼트의 페이지 테이블에서 변환 수행
3. 미사용 세그먼트는 페이지 테이블이 아예 없음 → 메모리 절약

#### ✅ 장점
- **드문드문(sparse) 사용되는 공간을 아예 페이지 테이블로 만들지 않음**
- 코드/힙/스택을 효율적으로 분리 관리 가능

#### ❌ 단점
- 세그멘테이션의 복잡성 유지
- 여전히 일부 세그먼트 내에서 페이지 낭비 발생
- 외부 단편화 가능성 존재

#### 📌 실제 사례
- **Multics 운영체제:** 최초로 이 방식을 구현

---

### 23.3 멀티 레벨 페이지 테이블 (Multi-Level Page Tables)

#### 🛠️ 구조
- 페이지 테이블을 **트리 구조(Tree Structure)** 로 나눔
- 사용 중인 주소 공간만 테이블로 유지하고, 나머지는 메모리에서 제거
- 가장 일반적인 형태가 **2단계 또는 3단계 페이지 테이블**

#### 🔍 예시
| 단계 | 역할 |
|-----|------|
| 페이지 디렉터리 (PD) | 하위 페이지 테이블의 위치 저장 |
| 페이지 테이블 (PT) | 물리 페이지 번호(PFN) 저장 |

#### ✅ 장점
- 사용된 주소 공간에 비례해서 페이지 테이블 메모리 사용 → **메모리 절약 극대화**
- 대규모 가상 주소 공간에서도 효율적 관리 가능 (32bit, 64bit)

#### ❌ 단점
- **TLB 미스 시, 여러 번 메모리 접근 필요** (PD → PT → 메모리)
- 선형 페이지 테이블에 비해 주소 변환 과정이 복잡

#### ⚙️ 적용 사례
- x86, ARM 등 대부분의 현대 CPU

---

### 23.4 역 페이지 테이블 (Inverted Page Table)

#### 🔄 개념
- 프로세스마다 페이지 테이블을 두지 않고, 시스템 전체에 **단 하나의 테이블**
- 물리 페이지 → 어떤 프로세스, 어떤 가상 페이지인지 기록

#### ✅ 장점
- 페이지 테이블 크기를 **물리 페이지 수만큼으로 제한**
- 메모리 사용량 최소화

#### ❌ 단점
- 가상 주소 → 물리 주소 변환 시 전체 테이블 검색 필요
- 해시 테이블 기반으로 구현하여 성능 보완 (예: PowerPC)

---

### 23.5 페이지 테이블의 스와핑

- 페이지 테이블도 메모리에서 부족하면 **디스크로 스와핑(swap)** 가능
- 일부 시스템(VAX/VMS 등)에서는 메모리 부족 시 페이지 테이블을 가상 메모리로 관리
- 하지만, 일반적으로는 자주 사용되므로 메모리에 상주시킴

---

## ✅ 요약

| 방식 | 특징 | 장점 | 단점 |
|------|------|------|------|
| 선형 테이블 | 단일 배열 | 단순, 빠름 | 공간 낭비 큼 |
| 큰 페이지 | 페이지 수 감소 | 테이블 작음 | 내부 단편화 증가 |
| 세그멘테이션+페이징 | 세그먼트 별 테이블 | 공간 낭비 감소 | 구조 복잡 |
| 멀티 레벨 | 트리 구조 | 미사용 공간 없음 | 변환 복잡 |
| 역 페이지 테이블 | 시스템 전체 공유 | 메모리 절약 | 변환 느림 |

📌 **결론:** 현대 시스템은 멀티 레벨 테이블을 주로 사용하며, TLB를 통해 변환 비용을 줄인다.  
공간 최적화와 시간 효율성의 **절충(time-space trade-off)** 을 고려해 자료구조를 설계해야 한다.

---

> 📚 출처: 『운영체제: 아주 쉬운 세 가지 이야기 (OSTEP)』
