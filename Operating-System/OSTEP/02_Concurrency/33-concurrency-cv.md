# 🔔 컨디션 변수 (OSTEP Chapter 33)

이 장에서는 병행 프로그램에서 자주 발생하는 **대기 및 신호 처리 문제**를 해결하기 위해 사용하는 **컨디션 변수(condition variable)** 를 설명한다.  
락은 공유 데이터에 대한 상호 배제를 보장하지만, **대기(waiting) 문제는 해결하지 못한다.**  
컨디션 변수는 이러한 대기 문제를 효율적으로 해결하는 데 사용된다.

---

## ❓ 핵심 질문

> 병행 프로그램에서 어떤 쓰레드가 **특정 조건이 충족될 때까지 기다릴 필요가 있을 때**, 어떻게 효율적이고 정확하게 처리할 수 있을까?

---

## 🔍 상세 개념 정리

---

### 33.1 정의와 루틴들

컨디션 변수는 주어진 조건이 **참이 될 때까지 기다릴 수 있도록 도와주는 병행성 기법**이다.  
Pthreads API는 다음과 같은 루틴을 제공한다.

- `pthread_cond_init()`: 컨디션 변수 초기화
- `pthread_cond_wait()`: 조건이 충족될 때까지 기다림
- `pthread_cond_signal()`: 대기 중인 하나의 쓰레드에게 신호 보냄
- `pthread_cond_broadcast()`: 대기 중인 모든 쓰레드에게 신호 보냄
- `pthread_cond_destroy()`: 컨디션 변수 파괴

특히 중요한 것은 `pthread_cond_wait()`의 동작 방식이다. 이 함수는 호출하면 먼저 락을 풀고 대기한다.  
그리고 조건이 충족되어 다시 깨어날 때 락을 다시 획득한 후 반환된다.  
→ 이 덕분에 락과 컨디션 변수를 안전하게 조합할 수 있다.

---

### 33.2 생산자/소비자(유한 버퍼) 문제

병행 프로그래밍의 대표적인 예제인 **생산자/소비자 문제**를 통해 컨디션 변수 사용 방법을 설명한다.  
유한 크기의 버퍼를 사용한다고 가정한다.

#### 데이터 구조

```c
pthread_mutex_t m;
pthread_cond_t c;
queue_t q;
```

#### 소비자 코드 예시

```c
pthread_mutex_lock(&m);
while (queue_empty(&q))
    pthread_cond_wait(&c, &m);
// 큐에서 데이터 제거
pthread_mutex_unlock(&m);
```

- 조건이 만족되지 않으면 while 루프에서 반복적으로 대기한다.
- 깨어나면 반드시 다시 조건을 검사해야 한다.

#### 생산자 코드 예시

```c
pthread_mutex_lock(&m);
queue_add(&q);
pthread_cond_signal(&c);
pthread_mutex_unlock(&m);
```

- 데이터가 추가된 후, 소비자에게 신호를 보낸다.
- 필요에 따라 `pthread_cond_broadcast()` 사용 가능.

---

### 33.3 컨디션 변수 사용 시 주의점

#### 락 보유

`pthread_cond_wait()` 를 호출하기 전에 반드시 락을 보유해야 한다.  
락 없이 wait를 호출하면 잘못된 동작을 초래할 수 있다.

#### while 루프 사용

조건 검사를 while 루프로 감싸야 한다.  
이유는 다음과 같다.

- 스푸리어스 웨이크업(spurious wakeup): 조건이 충족되지 않았는데 깨어날 수 있음
- 여러 생산자/소비자가 동시에 대기하는 경우, 조건이 여전히 충족되지 않았을 수도 있음

#### 코드 예시 (잘못된 사용)

```c
pthread_mutex_lock(&m);
if (queue_empty(&q))
    pthread_cond_wait(&c, &m);
// 큐에서 데이터 제거
pthread_mutex_unlock(&m);
```

→ if문은 안전하지 않음.

#### 코드 예시 (올바른 사용)

```c
pthread_mutex_lock(&m);
while (queue_empty(&q))
    pthread_cond_wait(&c, &m);
// 큐에서 데이터 제거
pthread_mutex_unlock(&m);
```

#### 락과 컨디션 변수의 역할 분리

- 락: 공유 데이터 보호
- 컨디션 변수: 대기 및 신호 관리

두 기능을 구분해서 사용해야 한다.

---

### 33.4 요약

컨디션 변수는 병행 프로그램에서 특정 조건이 충족될 때까지 **효율적으로 대기하고 신호를 주고받는 기능을 제공**한다.  
락이 공유 데이터의 상호 배제를 보장한다면, 컨디션 변수는 대기 및 신호 처리를 관리한다.

| API 함수 | 설명 |
|----------|------|
| pthread_cond_wait() | 조건이 충족될 때까지 기다림 |
| pthread_cond_signal() | 하나의 대기 쓰레드에게 신호 |
| pthread_cond_broadcast() | 모든 대기 쓰레드에게 신호 |

컨디션 변수는 항상 락과 함께 사용해야 하며, **조건 검사는 반드시 while 루프로 반복**해야 한다.

---

> 📚 출처: 『운영체제: 아주 쉬운 세 가지 이야기 (OSTEP)』
