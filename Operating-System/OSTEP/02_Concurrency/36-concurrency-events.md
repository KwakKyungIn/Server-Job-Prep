# ⚡ 이벤트 기반의 병행성(고급) (OSTEP Chapter 36)

이 장에서는 병행성 문제를 해결하는 **다른 방식인 이벤트 기반(event-based) 방식**을 다룬다.  
앞서 배운 락(lock), 컨디션 변수, 세마포어는 **명시적으로 병행성 문제를 관리**하는 방식이지만, 이벤트 기반 프로그래밍은 다른 철학을 따른다.

---

## ❓ 핵심 질문

> 병행성 문제를 **락이나 컨디션 변수 없이도 해결할 수 있는 방법**이 있을까?  
> 이벤트 기반 프로그래밍은 어떤 구조로 병행성을 처리하며, 그 장단점은 무엇일까?

---

## 🔍 상세 개념 정리

---

### 36.1 기본 개념: 이벤트 루프

이벤트 기반 시스템의 핵심은 **하나의 루프(loop)** 안에서 발생하는 이벤트들을 기다렸다가 처리하는 것이다.  
이벤트 루프(event loop)는 다음 순서로 동작한다.

1. 이벤트 발생을 기다림
2. 이벤트가 발생하면 관련 처리 함수(callback) 호출
3. 다시 이벤트 대기

이 방식은 단일 쓰레드로도 여러 작업을 처리할 수 있게 한다.

---

### 36.2 중요 API: select() (또는 poll())

이벤트 루프는 **select()**, **poll()**, **epoll()** 같은 시스템 콜을 통해 여러 I/O 이벤트를 감지한다.  
이 API들은 **여러 파일 디스크립터에서 발생하는 이벤트를 동시에 모니터링**한다.

| API | 설명 |
|-----|------|
| select() | 고전적인 방식 |
| poll() | select() 의 확장 |
| epoll() | 대규모 시스템에 최적화 (Linux 전용) |

---

### 36.3 select()의 사용

#### 기본 동작 흐름

1. 관심 있는 파일 디스크립터 설정
2. select() 호출로 이벤트 발생 대기
3. 이벤트 발생 시 어떤 디스크립터에 이벤트가 발생했는지 확인
4. 해당 작업 처리

#### 코드 구조 예시
```c
while (1) {
    select(...);
    if (event on fd1)
        handle_fd1();
    if (event on fd2)
        handle_fd2();
}
```

→ **while 루프 안에서 이벤트 대기 및 처리**를 반복한다.

---

### 36.4 왜 간단한가? 락이 필요 없음

이벤트 기반 모델의 가장 큰 장점은 락이 필요 없다는 점이다.

| 이유 | 설명 |
|------|------|
| 단일 쓰레드 | 이벤트 루프가 하나의 쓰레드에서 동작 |
| 순차 처리 | 이벤트가 하나씩 처리됨 |
| 공유 데이터 없음 | 병행으로 인한 경쟁 조건 발생 안 함 |

→ 병행성이 있지만, 동시 실행(concurrent execution)이 아닌 **순차 실행(serial execution)**.

---

### 36.5 문제: 블로킹 시스템 콜(Blocking System Call)

이벤트 루프 안에서 만약 시스템 콜이 블로킹(blocking) 상태에 빠지면, 전체 이벤트 처리가 멈춘다.  
예를 들어 read()가 데이터를 기다리느라 멈추면 다른 이벤트도 처리 불가.

→ 이 문제를 해결하지 않으면 전체 시스템이 멈추게 된다.

---

### 36.6 해법: 비동기 I/O

이 문제를 해결하기 위한 방법 중 하나는 **비동기 I/O(asynchronous I/O)** 사용이다.

| 방식 | 설명 |
|------|------|
| 비동기 read() | 호출 즉시 반환, 완료 시 이벤트 발생 |
| 비동기 write() | 비슷한 방식으로 처리 |

Linux에서는 aio_read(), aio_write() 같은 API가 제공된다.

비동기 I/O는 하드웨어 및 운영체제의 지원이 필요하며, 구현이 어렵다.

---

### 36.7 또 다른 문제점: 상태 관리

이벤트 기반 방식에서는 **상태 관리(state management)** 가 매우 복잡하다.  
각 작업의 상태를 저장하고, 이벤트가 발생할 때 적절히 복원해야 한다.

| 병행 방식 | 상태 관리 |
|----------|----------|
| 쓰레드 기반 | 스택에 자동 저장 |
| 이벤트 기반 | 명시적으로 저장 필요 |

→ 프로그램이 복잡해지며 유지 보수가 어려워질 수 있다.

---

### 36.8 이벤트 사용의 어려움

이벤트 기반 방식의 단점은 다음과 같다.

- 비동기 I/O 구현의 어려움
- 상태 관리 코드가 복잡해짐
- 에러 처리 및 복구가 어려움
- 디버깅이 까다로움

그래서 현대 시스템에서는 이벤트 기반과 쓰레드 기반을 혼합하여 사용하는 경우도 많다.

---

### 36.9 요약

이벤트 기반 프로그래밍은 병행성을 처리하는 또 다른 방식이다.  
락이나 컨디션 변수를 사용하지 않고도 여러 작업을 처리할 수 있다.  
하지만 비동기 I/O, 상태 관리 등 복잡한 부분이 많다.

| 장점 | 단점 |
|-----|------|
| 락 불필요 | 블로킹 콜 문제 |
| 단일 쓰레드로 동작 | 상태 관리 복잡 |
| 효율적 자원 사용 | 코드 유지 보수 어려움 |

이벤트 기반 방식은 웹 서버, GUI 프로그래밍 등에서 널리 사용된다.

---

> 📚 출처: 『운영체제: 아주 쉬운 세 가지 이야기 (OSTEP)』
