# 🐞 병행성 관련 오류 (OSTEP Chapter 35)

이 장에서는 병행성 프로그램에서 발생할 수 있는 **다양한 오류 유형**을 정리한다.  
병행성 문제는 발견하기 어렵고, 재현도 어렵고, 수정도 까다롭다.  
여기서 다루는 오류 유형을 이해하는 것이 올바른 병행 프로그램을 만드는 첫걸음이다.

---

## ❓ 핵심 질문

> 병행성 프로그램에서 발생하는 오류들은 어떤 종류가 있으며, 각각의 오류가 발생하는 이유는 무엇일까?  
> 이러한 오류들은 어떻게 식별하고 예방할 수 있을까?

---

## 🔍 상세 개념 정리

---

### 35.1 오류의 종류

#### 병행성 오류의 주요 분류

| 오류 유형 | 설명 |
|----------|------|
| 원자성 부재 (Atomicity Violation) | 여러 명령어가 원자적이지 않게 실행됨 |
| 순서 오류 (Order Violation) | 실행 순서가 예상과 다르게 발생 |
| 교착 상태 (Deadlock) | 서로 기다리다가 멈춤 |

이 장에서는 **원자성 부재**, **순서 오류**, **교착 상태**를 포함한 다양한 오류 유형을 예제와 함께 설명한다.

---

### 35.2 비 교착 상태 오류

#### 35.2.1 원자성 부재

##### 정의
한 번에 실행되어야 하는 코드 블록이 여러 쓰레드에 의해 나누어 실행되어 잘못된 결과 발생.

##### 예제
```c
balance = balance + 1;
```
락으로 보호하지 않으면 두 쓰레드가 동시에 실행되어 오류 발생 가능.

##### 발생 조건
- 공유 데이터 접근
- 보호 코드 누락

#### 35.2.2 순서 오류

##### 정의
어떤 코드가 **다른 코드가 완료된 후** 실행되어야 하는데 순서가 지켜지지 않음.

##### 예제
```c
pthread_create(&t, NULL, thread_func, NULL);
pthread_join(t, NULL);
```

만약 join을 생략하면 thread_func이 끝나기 전에 main 함수가 종료될 수 있다.

##### 발생 조건
- 쓰레드 간 의존 관계 누락
- 컨디션 변수나 세마포어 사용 누락

---

### 35.3 교착 상태 오류

#### 35.3.1 교착 상태의 발생 조건

| 조건 | 설명 |
|------|------|
| 상호 배제 | 자원을 공유 불가 |
| 보유 및 대기 | 이미 보유한 자원을 가진 채 다른 자원 요청 |
| 비선점 | 강제로 자원 회수 불가 |
| 순환 대기 | 쓰레드 간 순환 구조 |

네 조건이 모두 충족될 때 교착 상태 발생.

#### 35.3.2 간단한 예제

##### 코드 예시
```c
pthread_mutex_lock(&lock1);
pthread_mutex_lock(&lock2);
```

두 쓰레드가 lock1, lock2를 반대 순서로 잡으려고 하면 서로 대기 상태 발생.

#### 35.3.3 교착 상태 예방 방법

| 방법 | 설명 |
|------|------|
| 자원 획득 순서 지정 | 모든 쓰레드가 같은 순서로 자원 요청 |
| 타임아웃 | 일정 시간 지나면 자원 요청 포기 |
| 검출 및 회복 | 교착 상태 발생 시 강제로 해결 |

---

### 35.4 요약

병행성 오류는 여러 종류가 있으며, 각각의 특성에 따라 적절한 해결책이 필요하다.

| 오류 유형 | 예시 | 해결 방법 |
|----------|------|------------|
| 원자성 부재 | balance += 1 | 락 사용 |
| 순서 오류 | 쓰레드 종료 대기 누락 | 컨디션 변수, 세마포어 |
| 교착 상태 | 락 순서 충돌 | 자원 획득 순서 통일 |

병행성 오류는 재현하기 어렵고, 디버깅이 어렵다. 따라서 **예방이 최선의 해결책이다.**

---

> 📚 출처: 『운영체제: 아주 쉬운 세 가지 이야기 (OSTEP)』
