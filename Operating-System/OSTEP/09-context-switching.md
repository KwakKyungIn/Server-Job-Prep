# 🔄 Chapter 9. 문맥 교환 (Context Switching)

## 📌 핵심 질문
> **CPU 실행 제어권을 OS가 되찾고**, 프로세스를 교체하려면 어떻게 해야 할까?

---

## ✅ 9.1 문맥 교환이란?

- 하나의 프로세스를 멈추고 다른 프로세스로 전환하는 작업
- 실행 중이던 프로세스의 **레지스터, 스택 포인터** 등을 저장
- 전환될 프로세스의 상태를 복원

---

## 🧠 두 단계 저장 구조

1. **하드웨어 저장**: 인터럽트 발생 시, 사용자 레지스터는 커널 스택에 저장됨
2. **소프트웨어 저장**: 커널 코드가 현재 문맥(context)을 PCB에 저장하고, 다음 프로세스의 문맥을 불러옴

---

## ✍️ 예시: xv6 문맥 교환 어셈블리

```asm
# old 프로세스 상태 저장
movl %esp, 4(%eax)
movl %ebx, 8(%eax)
...

# new 프로세스 상태 복원
movl 28(%eax), %ebp
movl 24(%eax), %edi
...
ret
```

---

## ✅ 스택 전환

- 커널 스택은 프로세스마다 다름
- 스위칭 시 스택 포인터도 함께 변경
- `return-from-trap` 시 복귀

---

## ⚠️ 주의사항

- 컨텍스트 스위치에는 비용이 발생함 (캐시 무효화 등)
- 너무 잦은 전환은 성능 저하를 유발할 수 있음

---

## ✅ 요약

| 항목 | 설명 |
|------|------|
| 목적 | 프로세스 전환 시 상태 저장/복원 |
| 방법 | 레지스터, PC, SP 저장 후 교체 |
| 위치 | PCB 및 커널 스택 |
| 성능 | 오버헤드 존재 (가급적 최소화) |

---

> 📚 출처: 『OSTEP Chapter 9 – Context Switching』
